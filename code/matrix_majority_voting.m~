function [accuracy] = matrix_majority_voting(anno, test_filt,train_filt, knn, dist_mat, weighted)
%----------------------------------------------------
% function prediction with majority voting by kNN
%----------------------------------------------------
    
    test_ind = find(test_filt);
    test_anno = anno(:, test_filt);

    labelled = sum(anno, 1) > 0;
    
    % only look at training indices with labels
    % this may be redundant since this filter happens earlier as well
    train_ind = intersect(find(train_filt), find(labelled));
    
    
    ntest = length(test_ind);
    
    % creates a matrix for scoring the test points
    class_score = zeros(ntest, size(anno, 1));
    
    parfor p = 1:ntest
        i = test_ind(p);    % gene id
        
        % collect all function labels from kNN neighbors
        fun = [];
        fun_weight = [];
        
        % indices of nearest neighbors
        iknn = knn(:,i);
        % only care about neighbors with labels
        voting_knn = intersect(iknn, train_ind);
        
        if isempty(voting_knn)
            continue;
        end
        
        votes = anno(:, voting_knn);
        if weighted 
            % weight is inversely proportional to distance
            weights = 1 ./ dist_mat(i, voting_knn);
            class_score(p, :) = votes * weights.';
        else
            class_score(p, :) = sum(votes, 2);
        end
    end
    
    % filter out any nodes that had no voting neighbors.
    had_votes = sum(class_score, 2) > 0;
    had_votes_anno = test_anno(:, had_votes);
    
    acc = acc(acc ~= -1); % filter out the nodes with no labelled neighbors
    accuracy = mean(acc);
end
